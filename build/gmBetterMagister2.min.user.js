// ==UserScript==
// @name 	BetterMagister2
// @namespace 	betterSgaMagisterNet2
// @description Verbeter de normale Magister 6
// @include 	https://*.magister.net/*
// @require  http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js
// @require https://rawgit.com/lightswitch05/table-to-json/master/lib/jquery.tabletojson.min.js
// @author 	Wouter Damen
// @version 	v1.12
// @grant 	GM_addStyle
// @grant	GM_setValue
// @grant	GM_getValue
// ==/UserScript==
var a="v1.12",b="v1.5.2",c="v1.7.1",d="v1.1",e=function(){GM_addStyle(" .settings-Setup-widget { height: 100%; width: 100%; background-color: rgba(0, 0, 0, 0.67); position: absolute; z-index: 999999; }"),GM_addStyle(" .settings-Setup-widget .block { width: 500px; margin: auto; background-color: #FFF; margin-top: 100px; border: 1px solid #111; }"),GM_addStyle(" .settings-Setup-widget fieldset { color: #FFF; font-size: 15px; }"),GM_addStyle(" .settings-Setup-form label { font-size: 1rem; font-weight: unset; padding-bottom: 0px !important; padding-left: 0px !important; }"),GM_addStyle(" .settings-Setup-form select { font-size: 0.8rem !important; padding: 0.2rem; width: 140; margin-bottom: 5px; }"),GM_addStyle(" .settings-Setup-widget button { margin-top: 0.1rem; margin-bottom: 10px; }"),GM_addStyle(" #styleVersion { padding: 0 8px 8px 8px !important; }"),GM_addStyle(" .settings-Setup-widget h3 { padding-top: 5px !important; font-weight: bold !important; }"),GM_addStyle(" .settings-Setup-widget .content { height: auto !important; }"),GM_addStyle(" .settings-Setup-form .checkbox-input label { font-size: 0.8rem; padding-left: 10px !important; }"),GM_addStyle(" .settings-Setup-form h5 { color: #FFF; font-size: 1rem; }"),GM_addStyle(' .settings-Setup-form .checkbox-input input[type="checkbox"]:checked + label span::after { position: relative !important; }'),$('<div class="settings-Setup-widget"><div class="block"><h3>BetterMagister Settings</h3><div class="content"><form class="settings-Setup-form"><label for="stylesheet">Stylesheet</label><p id="styleVersion"></p><select name="stylesheet" id="stylesheet"><option value="metro">Metro UI</option><option value="darkmode">Dark Mode</option><option value="defaultmode">Default</option></select></form><button>Opslaan</button></div><footer class="endlink"><p>BetterMagister '+a+"</p><a>sluiten</a></footer></div></div>").prependTo("body"),$('<label for="settings-Agenda">Agenda weergave</label><p style="padding: 0 8px 8px 8px !important">Verandert de agendaweergave automatisch</p><select name="settings-Agenda" id="settings-Agenda"><option value="lijst">Afsprakenlijst</option><option value="dag">Dagoverzicht</option><option value="week">Weekoverzicht</option><option value="werkweek">Werkweekoverzicht</option></select>').appendTo(".settings-Setup-form"),$('<h5>Inloggen</h5><p style="padding: 0 8px 8px 8px !important">Alle wachtwoorden worden locaal en versleuteld opgeslagen.</p><div class="checkbox-input" id="login"><input class="ng-pristine ng-untouched ng-valid" name="rememberpw" data-ng-model="rememberUsername" id="rememberpw" tabindex="3" type="checkbox"><label for="rememberpw"><span></span>Wachtwoord onthouden</label><input class="ng-pristine ng-untouched ng-valid" name="autologin" data-ng-model="rememberUsername" id="autologin" tabindex="3" type="checkbox"><label for="autologin"><span></span>Automatisch Inloggen</label></div>').appendTo(".settings-Setup-form"),GM_getValue("settings-darkMode",!1)?($(".settings-Setup-form select#stylesheet").val("darkmode"),$("#styleVersion").text("Huidige Stylesheet: "+c)):GM_getValue("settings-MetroUI",!1)?($(".settings-Setup-form select#stylesheet").val("metro"),$("#styleVersion").text("Huidige Stylesheet: "+b)):$(".settings-Setup-form select").val("defaultmode"),$(".settings-Setup-form select#settings-Agenda").val(GM_getValue("settings-Agenda","lijst")),$("#login > label:nth-child(2) > span:nth-child(1)").click(function(){$("#rememberpw").toggleClass("checked")}),$("#login > label:nth-child(4) > span:nth-child(1)").click(function(){$("#autologin").toggleClass("checked")}),GM_getValue("settings-Savepw",!1)&&$("#login > label:nth-child(2) > span:nth-child(1)").click(),GM_getValue("settings-autoLogin",!1)&&$("#login > label:nth-child(4) > span:nth-child(1)").click(),$(".settings-Setup-widget button").click(function(){"metro"==$(".settings-Setup-form select#stylesheet").val()?(GM_setValue("settings-darkMode",!1),GM_setValue("settings-MetroUI",!0)):"darkmode"==$(".settings-Setup-form select#stylesheet").val()?(GM_setValue("settings-darkMode",!0),GM_setValue("settings-MetroUI",!1)):"defaultmode"==$(".settings-Setup-form select#stylesheet").val()&&(GM_setValue("settings-darkMode",!1),GM_setValue("settings-MetroUI",!1)),GM_setValue("settings-Agenda",$(".settings-Setup-form select#settings-Agenda").val()),$("#rememberpw").hasClass("checked")?GM_setValue("settings-Savepw",!0):GM_setValue("settings-Savepw",!1),$("#autologin").hasClass("checked")?(GM_setValue("settings-autoLogin",!0),GM_setValue("settings-Savepw",!0)):GM_setValue("settings-autoLogin",!1),GM_setValue("settings-Setup",!1),$(".settings-Setup-widget").remove()}),$(".settings-Setup-widget a").click(function(){$(".settings-Setup-widget").remove()})},f=function(a,b){var c=$('<div id="mWidget"><div class="block"><h3>Mutaties</h3><div class="content"><p id="vak"></p><p id="tot"></p><p id="weg"></p><p id="gem"></p></div><footer class="endlink"><a>Sluiten</a></footer></div></div>');GM_addStyle("#mWidget { height: 100%; width: 100%; background-color: rgba(0, 0, 0, 0.67); position: absolute; z-index: 999999;  } "),GM_addStyle("#mWidget .block { width: 500px; margin: auto; background-color: #FFF; margin-top: 100px; border: 1px solid #111; }"),GM_addStyle("#mWidget .block h3 { padding-top: 5px !important; }"),GM_addStyle('#vak::before { content: "Vak: "; } #tot::before { content: "Som Cijfers: "; } #weg::before { content: "Som Weging: "; } #gem::before { content: "Gemiddelde: "; }'),GM_addStyle("#mWidget .content { height: auto !important; }"),c.prependTo("body"),$("#vak").text(a),jQuery.each(b,function(a,b){b.Cijfer=Number(b.Cijfer.split(",")[0])+Number(b.Cijfer.split(",")[1])/10,b.Weging=Number(b.Weging)});var d=0,e=0;jQuery.each(b,function(a,b){d+=b.Cijfer*b.Weging,e+=b.Weging});var f=d/e;$("#tot").text(d),$("#weg").text(e),$("#gem").text(f),$("#mWidget .endlink a").click(function(){c.remove()}),GM_addStyle("#nieuwCijfer { width: 90%; margin: auto; } "),GM_addStyle("#nieuwCijfer p { width: 8%; float: left; padding: 4px 0 0 0; }"),GM_addStyle("#nieuwCijfer input::-moz-placeholder { color: #000; }"),GM_addStyle("#weging { margin-bottom: 2px; } #gemiddelde { width: 46%; float: left; } #cijfer { width: 46%; float: right; }"),$('<div id="nieuwCijfer"><form><input id="weging" type="text" placeholder="Weging (bv. 4)"><input id="gemiddelde" type="text" placeholder="Doel gemiddelde (bv. 7.5)"><p>of</p><input id="cijfer" type="text" placeholder="Cijfer (bv. 8.9)"></form></div>').appendTo("#mWidget .content"),GM_addStyle("#bereken { margin: 4px 4px 4px 4px; }"),$('<button id="bereken">Bereken</button>').appendTo("#mWidget .content"),$('<p id="error" style="color: red"></p>').appendTo("#mWidget .content"),$("#gemiddelde").change(function(){$("#cijfer").val("")}),$("#cijfer").change(function(){$("#gemiddelde").val("")}),$("#bereken").click(function(){if(""!=$("#weging").val()&&(""!=$("#gemiddelde").val()||""!=$("#cijfer").val()))if("NaN"==Number($("#weging").val()).toString())$("#error").text('Error: "Cijfer" is geen nummer (hint: Gebruik voor een comma een .; "4.1" ipv "4,1")');else if(""!=$("#gemiddelde").val()&&"NaN"==Number($("#gemiddelde").val()).toString())$("#error").text('Error: "Cijfer" is geen nummer (hint: Gebruik voor een comma een .; "4.1" ipv "4,1")');else if(""!=$("#cijfer").val()&&"NaN"==Number($("#cijfer").val()).toString())$("#error").text('Error: "Cijfer" is geen nummer (hint: Gebruik voor een comma een .; "4.1" ipv "4,1")');else if($("#error").text(""),""!=$("#gemiddelde").val()){var a=Number($("#gemiddelde").val()),b=Number($("#weging").val()),c=(a*(e+b)-d)/b;$("<p>Cijfer dat je moet halen om "+a+" te staan: "+c+"</p>").appendTo("#mWidget .content")}else if(""!=$("#cijfer").val()){var c=Number($("#cijfer").val()),b=Number($("#weging").val()),a=(d+c*b)/(e+b);$("<p>Nieuw gemiddelde: "+a+"</p>").appendTo("#mWidget .content")}})},l=function(){$(".grade-gemiddelde").hide();var a=0;$(".gradeHeader").each(function(b){$(this).text().contains("G-R")&&(a=b)});var b=0,c=$(".k-selectable > tbody:nth-child(2) > tr > td:nth-child("+(a+3).toString()+") > span:nth-child(1)").length;$(".k-selectable > tbody:nth-child(2) > tr > td:nth-child("+(a+3).toString()+") > span:nth-child(1)").each(function(a){var d=$(this).text();return" "==d?void(c-=1):void(b+=Number(d.split(",")[0])+Number(d.split(",")[1])/100)});var d=b/c;gP=d.toPrecision(3),$(".grade-gemiddelde .cijfer.gemiddelde").text(gP.toString());var e=0,f=0;$(".grade").each(function(a){if(!$(this).hasClass("gemiddeldecolumn"))return $(this).hasClass("insufficient")?void f++:$(this).hasClass("empty")?void 0:void e++});var g=(e/(e+f)*100).toPrecision(2);$(".grade-gemiddelde .cijfer.percentage").text(g);var h=$("#vQelect").val();jQuery.each(h,function(a,b){h[a]=" P"+h[a]}),$(".grade-gemiddelde .subtitle").text("in"+h.toString());var i=0,j=0;$(".k-selectable > tbody:nth-child(2) > tr > td:nth-child("+(a+4).toString()+") > span:nth-child(1)").each(function(a){var b=$(this).text();if(" "!=b){var c=Number(b);c>6?j+=c-6:c<6&&(i+=6-c)}}),j>i?i=0:i>j&&(i-=j,$(".cijfer.tD").addClass("insufficient")),$(".grade-gemiddelde .cijfer.tD").text(i.toString()),$(".grade-gemiddelde").show(400)},m=function(){var a=setInterval(function(){if($("#cijferoverzichtgrid").length){clearInterval(a);setTimeout(function(){$(".k-selectable tbody").children()&&$(".content-container-cijfers").html('<div class="loading-overlay ng-isolate-scope"><div class="icon-no-data"><p class="no-items">Geen gegevens</p></div></div>'),$(".gemiddeldecolumn").bind("click",function(){$('<footer class="endlink"><a id="mLink">Mutaties berekenen</a></footer>').appendTo("#idBerekening .block"),$(".gemiddeldecolumn").unbind(),$("#idBerekening footer a").click(function(){var a=$("td.k-state-selected").parent().attr("data-uid"),b=$('tr[data-uid="'+a+'"] > td:nth-child(2) > span:nth-child(1)').text();f(b,$(".cijfer-berekend").tableToJSON())})}),$('<div class="grade-gemiddelde"><span class="cijfer gemiddelde"></span><span class="omschrijving">Gemiddelde</span></div>').appendTo(".content-container-cijfers"),$('<div class="grade-gemiddelde"><span class="cijfer percentage"></span><span class="omschrijving">vol</span><span class="subtitle"></span></div>').appendTo(".content-container-cijfers"),$('<div class="grade-gemiddelde"><span class="cijfer tD"></span><span class="omschrijving">Te Compenseren</span></div>').appendTo(".content-container-cijfers"),l()},1e3)}},1e3)},o=function(a){var b=setInterval(function(){$("#menuKnopAgenda").length&&("lijst"==a?$("#menuKnopAgenda").attr("href","#/agenda?trk=main-menu"):"dag"==a?$("#menuKnopAgenda").attr("href","#/agenda/dag"):"week"==a?$("#menuKnopAgenda").attr("href","#/agenda/week"):"werkweek"==a&&$("#menuKnopAgenda").attr("href","#/agenda/werkweek"),clearInterval(b))},100)},p=function(){$('<script type="text/javascript" src="https://rawgit.com/apeklets/BetterMagister/gh-pages/build/js/updateChecker.js"></script>').appendTo("head");var b=setInterval(function(){$(".toasts").length&&($('<script type="text/javascript">var a = '+a+"; if(a != BetterMagisterInfo.bmVersion) {updateAlert();}</script>").appendTo("head"),clearInterval(b))},1e3)},n=function(){var a=setInterval(function(){$(".text-input #password").length&&(GM_addStyle("#checkbox-rememberpw { margin-top: 35px; }"),GM_addStyle(".account .checkbox-input { height: 0px !important; }"),$('<div class="checkbox-input" id="checkbox-rememberpw"><input class="ng-pristine ng-untouched ng-valid" name="rememberpw" data-ng-model="rememberUsername" id="rememberpw" tabindex="3" type="checkbox"><label for="rememberpw"><span></span>Wachtwoord onthouden</label></div>').appendTo(".content fieldset"),GM_getValue("saved-Password",!1)!==!1&&(GM_getValue("settings-Savepw",!1)||GM_getValue("settings-autoLogin",!1))&&($("#password").val(GM_getValue("saved-Password","")),GM_getValue("settings-autoLogin",!1)?$("<script type=\"text/javascript\">$('#password').change(); $('.btn-primary3').click()</script>").appendTo("head"):$("<script type=\"text/javascript\">$('#password').change()</script>").appendTo("head")),(GM_getValue("settings-Savepw",!1)||GM_getValue("settings-autoLogin",!1))&&$('#checkbox-rememberpw input[type="checkbox"]').attr("checked","checked"),$(".btn-primary3").click(function(){1==$('#checkbox-rememberpw input[type="checkbox"]:checked').length?(GM_setValue("saved-Password",$(".text-input #password").val()),GM_setValue("settings-Savepw",!0)):GM_setValue("settings-Savepw",!1)}),clearInterval(a))},100)},r=function(){GM_addStyle(" .settings-Settings { border-left: 1px solid #666; position: relative; cursor: pointer; }"),GM_addStyle(" .settings-Settings:hover { background-color: #000 !important; }"),GM_addStyle(" .account .settings-Settings { display: none !important; }"),$('<div class="settings-Settings"><span class="icon-settings" style="color: red !important"></span></div>').appendTo(".header"),GM_getValue("settings-darkMode",!1)&&$('<link rel="stylesheet" href="https://rawgit.com/apeklets/BetterMagister/gh-pages/build/css/darkmode.min.css">').appendTo("head"),GM_getValue("settings-MetroUI",!1)&&$('<link rel="stylesheet" href="https://rawgit.com/apeklets/BetterMagister/gh-pages/build/css/metro.min.css">').appendTo("head"),"account"==$("body").attr("class")&&n(),$(".settings-Settings").click(function(){e()}),o(GM_getValue("settings-Agenda","lijst"));var a=window.location.hash;"#/cijfers"==a?m():window.addEventListener("hashchange",function(){"#/cijfers"==window.location.hash&&m()},!1),"#/inloggen"!=a&&p()};$(document).ready(r);